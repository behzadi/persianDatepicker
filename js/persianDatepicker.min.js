/*!
 * persianDatepicker v0.1.0
 * http://github.com/behzadi/persianDatepicker/
 * http://mbehzadi.com/persianDatepicker/
 *
 * Copyright (c) 2013 Mohammad hasan Behzadi  All rights reserved.
 * 
 * Released under the MIT license.
 *
 * jalali Date Functions from NASA.gov 
 *
 * Date: Tue Jan 1 2013
 */
(function(){$.fn.persianDatepicker=function(n){var i="persianDatepicker",r=this.data(i);return r?n===!0?r:this:this.each(function(){return $(this).data(i,new t(this,n))})};var t=function(){function n(n,t){var e={months:["فروردین","اردیبهشت","خرداد","تیر","مرداد","شهریور","مهر","آبان","آذر","دی","بهمن","اسفند"],dowTitle:["شنبه","یکشنبه","دوشنبه","سه شنبه","چهارشنبه","پنج شنبه","جمعه"],shortDowTitle:["ش","ی","د","س","چ","پ","ج"],showGregorianDate:!1,persianNumbers:!0,formatDate:"YYYY/MM/DD",selectedBefore:!1,prevArrow:"◄",nextArrow:"►",theme:"default",alwaysShow:!1,selectableYears:null,selectableMonths:[1,2,3,4,5,6,7,8,9,10,11,12],cellWidth:25,cellHeight:20,fontSize:13,isRTL:!1,calendarPosition:{x:0,y:0},onShow:function(n){n.show()},onHide:function(n){n.hide()}},i=this,r,o,f;i.el=$(n),r=i.el,i.options=$.extend(!0,{},e,t),o=i.options,_fontSize=i.options.fontSize,i.cellStyle="style='width:"+i.options.cellWidth+"px;height:"+i.options.cellHeight+"px;line-height:"+i.options.cellHeight+"px; font-size:"+_fontSize+"px; ' ",i.headerStyle="style='height:"+i.options.cellHeight+"px;line-height:"+i.options.cellHeight+"px; font-size:"+(_fontSize+4)+"px;' ",i.selectUlStyle="style='margin-top:"+i.options.cellHeight+"px;height:"+(i.options.cellHeight*7+20)+"px; font-size:"+(_fontSize-2)+"px;' ",i.selectMonthLiStyle="style='height:"+(i.options.cellHeight*7+7)/4+"px;line-height:"+(i.options.cellHeight*7+7)/4+"px; width:"+(7*i.options.cellWidth+1)/3+"px;width:"+7*i.options.cellWidth/3+"px\\9;' ",i.selectYearLiStyle="style='height:"+(i.options.cellHeight*7+10)/6+"px;line-height:"+(i.options.cellHeight*7+10)/6+"px; width:"+(7*i.options.cellWidth-14)/3+"px;width:"+(7*i.options.cellWidth-15)/3+"px\\9;' ",i.footerStyle="style='height:"+i.options.cellHeight+"px;line-height:"+i.options.cellHeight+"px; font-size:"+_fontSize+"px;' ",i.jDateFunctions=new u,_persianDate=i.now(),i.options.selectableYears!=undefined&&i.options.selectableYears._indexOf(_persianDate.year)==-1&&(_persianDate.year=this.options.selectableYears[0]),i.options.selectableMonths._indexOf(_persianDate.month)==-1&&(_persianDate.month=this.options.selectableMonths[0]),i.persianDate=_persianDate,i._id="pdp-"+Math.round(Math.random()*1e7),i.persianDate.formatDate=i.options.formatDate,i.calendar=$('<div id="'+i._id+'" class="pdp-'+i.options.theme+'" />'),(r.attr("pdp-id")||"").length||r.attr("pdp-id",i._id),r.addClass("pdp-el").bind("click",function(n){i.show(n)}).bind("focus",function(n){i.show(n)}),i.options.selectedBefore&&!i.options.showGregorianDate&&i.showDate(r,i.now().toString(i.options.formatDate)),i.options.selectedBefore&&i.options.showGregorianDate&&i.showDate(r,i.now().gDate._toString(i.options.formatDate)),i.options.isRTL&&r.addClass("rtl"),i.calendar.length&&!o.alwaysShow&&i.calendar.hide(),$(document).bind("mouseup",function(n){var u=n.target,f=i.calendar,t;r.is(u)||f.is(u)||f.has(u).length!==0||!f.is(":visible")||i.hide(),t=$(".pdp-"+i.options.theme+" .yearSelect"),t.is(n.target)||t.has(n.target).length!==0||t.hide(),t=$(".pdp-"+i.options.theme+" .monthSelect"),t.is(n.target)||t.has(n.target).length!==0||t.hide()}),f=function(){var n=r.offset();i.calendar.css({top:n.top+r.outerHeight()+i.options.calendarPosition.y+"px",left:n.left+i.options.calendarPosition.x+"px"})},$(window).resize(f),f(),$("body").append(i.calendar),i.render()}return n.prototype={show:function(){$.each($(".pdp-el").not(this.el),function(n,t){if(t.length)t.options.onHide(t.calendar)});this.options.onShow(this.calendar)},hide:function(){if(this.options&&!this.options.alwaysShow)this.options.onHide(this.calendar)},render:function(){this.calendar.children().remove(),this.header(),this.dows(),this.content(),this.footer()},header:function(){var n=this,h,o,s;_monthYear=$('<div class="" />'),_monthYear.appendTo(this.calendar),_head=$('<div class="header" '+n.headerStyle+" />"),_head.appendTo(this.calendar),_next=$('<div class="nextArrow" />').html(this.options.nextArrow).attr("title","ماه بعد").bind("click",function(){for(nextMonth=n.persianDate.month+1;n.options.selectableMonths._indexOf(nextMonth)==-1&&nextMonth<13;nextMonth++);n.persianDate.addMonth(nextMonth-n.persianDate.month),n.render()}),_next.appendTo(_head);var r=$('<ul class="monthSelect" '+n.selectUlStyle+" />").hide(),t=$('<ul class="yearSelect" '+n.selectUlStyle+" />").hide(),f=$("<span/>").html(n.options.months[n.persianDate.month-1]).mousedown(function(){return!1}).click(function(n){n.stopPropagation(),t.css({display:"none"}),r.css({display:"inline-block"})}),e=$("<span/>").html(n.options.persianNumbers?n.jDateFunctions.toPersianNums(n.persianDate.year):n.persianDate.year).mousedown(function(){return!1}).click(function(n){n.stopPropagation(),r.css({display:"none"}),t.css({display:"inline-block"}),t.scrollTop(70)}),u=function(r,u){var f=!1,e;for(r===undefined&&u===undefined?(b=n.persianDate.year-19,a=n.persianDate.year+29):u==0?(a=r,b=a-6,f=!0):r==0&&(b=u,a=b+6),e=[],i=b;i<a&&a>0;i++)e.push(parseInt(i));$.each(n.options.selectableYears||e,function(i,r){var u=$("<li "+n.selectYearLiStyle+" />").html(n.options.persianNumbers?n.jDateFunctions.toPersianNums(r):r);r==n.persianDate.year&&u.addClass("selected"),u.attr("value",r),u.bind("click",function(){n.persianDate.date=1,n.persianDate.year=parseInt(r),n.render()}),f?t.prepend(u):t.append(u)})};u(),h=function(){var t=[];for(i=0;i<12;i++)t.push(n.options.months[i]);return t},o=function(){var t=[];for(i=0;i<12;i++)t.push(n.options.months[i]);return t},$.each(o(),function(t,i){var u=n.options.selectableMonths._indexOf(t+1)==-1?$('<li class="desableMonth" '+n.selectMonthLiStyle+" />").html(i):$("<li "+n.selectMonthLiStyle+" />").html(i);t+1==n.persianDate.month&&u.addClass("selected"),u.data("month",i),u.bind("click",function(){u.hasClass("desableMonth")||(n.persianDate.date=1,n.persianDate.month=parseInt(t+1),n.render())}),r.append(u)}),t.bind("scroll",function(){n.options.selectableYears==undefined&&(c=$(this).find("li").length,firstYear=parseInt($(this).find("li:first").val()),lastYear=parseInt($(this).children("li:last").val()),lisHeight=c/3*($(this).find("li:first").height()+4),_com=$(this).scrollTop().toString().length*500,$(this).scrollTop()<_com.toString().length*1e3&&firstYear>=1&&u(firstYear,0),_com=$(this).scrollTop().toString().length*100,lisHeight-$(this).scrollTop()>-_com&&lisHeight-$(this).scrollTop()<_com&&(u(0,lastYear),$(this).scrollTop($(this).scrollTop()-50)),$(this).scrollTop()<_com.toString().length&&$(this).scrollTop(_com.toString().length*500))}),_monthYear.append(r).append(t),s=$('<div class="monthYear" />').append(f).append("<span>&nbsp;&nbsp;<\/span>").append(e),_head.append(s),_prev=$('<div class="prevArrow" />').html(this.options.prevArrow).attr("title","ماه قبل").bind("click",function(){for(prevMonth=n.persianDate.month-1;n.options.selectableMonths._indexOf(prevMonth)==-1&&prevMonth>0;prevMonth--);n.persianDate.addMonth(-(n.persianDate.month-prevMonth)),n.render()}),_prev.appendTo(_head)},dows:function(){for(_row=$('<div class="dows" />'),i=0;i<7;i++)_cell=$('<div class="dow cell " '+this.cellStyle+" />").html(this.options.shortDowTitle[i]),_cell.appendTo(_row);_row.appendTo(this.calendar)},content:function(){var n=this,r,t,i;for(_days=$('<div class="days" />'),_days.appendTo(this.calendar),jd=n.persianDate,jd.date=1,_start=n.jDateFunctions.getWeekday(n.jDateFunctions.getJulianDayFromPersian(jd)),_end=n.jDateFunctions.getLastDayOfPersianMonth(n.persianDate),r=0,t=0;r<6;r++){for(_row=$("<div />"),i=0;i<7;i++,t++)t<_start||t-_start+1>_end?_cell=$('<div class="nul cell " '+n.cellStyle+" />").html("&nbsp;"):(_dt=n.getDate(n.persianDate,t-_start+1),_today="",_selday="",n.now().compare(_dt)==0&&(_today="today"),t-_start+1==n.now().date&&(_selday="selday"),_fri=i==6?"friday":"",_cell=$('<div class="day cell '+_fri+" "+_today+" "+_selday+'" '+n.cellStyle+" />"),_cell.data("date",{jDate:_dt.toString("YYYY/MM/DD/DW"),gDate:n.jDateFunctions.getGDate(_dt)._toString(n.options.formatDate)}),_cell.html(n.options.persianNumbers?n.jDateFunctions.toPersianNums(t-_start+1):t-_start+1).bind("click",function(){n.calendar.find(".day").removeClass("selday"),$(this).addClass("selday"),n.options.showGregorianDate?n.showDate(n.el,$(this).data("date").gDate):n.showDate(n.el,n.persianDate.parse($(this).data("date").jDate).toString(n.options.formatDate)),n.calendar.hide()})),_cell.appendTo(_row);_row.appendTo(_days)}},footer:function(){var n=this;_footer=$('<div class="footer" '+n.footerStyle+" />"),_footer.appendTo(this.calendar),n.options.selectableMonths._indexOf(n.persianDate.month)>-1&&(_goToday=$('<a class="goToday" />'),_goToday.data("date",{jDate:n.now().toString("YYYY/MM/DD/DW"),gDate:n.jDateFunctions.getGDate(n.now())._toString(n.options.formatDate)}),_goToday.attr("href","javascript:;").html("هم اکنون").bind("click",function(){n.persianDate=n.now(),n.options.showGregorianDate?n.showDate(n.el,$(this).data("date").gDate._toString(n.options.formatDate)):n.showDate(n.el,n.persianDate.parse($(this).data("date").jDate).toString(n.options.formatDate)),n.calendar.find(".day").removeClass("selday"),n.render(),n.calendar.find(".today").addClass("selday"),n.hide()}),_goToday.appendTo(_footer))},showDate:function(n,t){n.is("input")?n.val(t):n.html(t)},getDate:function(n,t){return n.date=t,n.day=this.jDateFunctions.getWeekday(this.jDateFunctions.getJulianDayFromPersian(n)),n},now:function(){return this.jDateFunctions.getPCalendarDate(this.jDateFunctions.getJulianDay(new Date))}},n}(),n=function(){function n(){var n=this;n.months=["فروردین","اردیبهشت","خرداد","تیر","مرداد","شهریور","مهر","آبان","آذر","دی","بهمن","اسفند"],n.dowTitle=["شنبه","یکشنبه","دوشنبه","سه شنبه","چهارشنبه","پنج شنبه","جمعه"],n.year=1300,n.month=1,n.date=1,n.day=1,n.gDate=new Date}return n.prototype={addMonth:function(n){return this.month+=n,this.month>=13?(this.month=1,this.addYear(1)):this.month<=0&&(this.month=12,this.addYear(-1)),this},addYear:function(n){this.year+=n},compare:function(n){if(n.year==this.year&&n.month==this.month&&n.date==this.date)return 0},parse:function(t){arr=t.split("/"),y=arr[0],m=arr[1],d=arr[2],wd=arr[3];var i=new n,r=new Date;return i.year=parseInt(y),i.month=parseInt(m),i.date=parseInt(d),i.day=wd,i.gDate=new Date,i},toString:function(n){return n===undefined?this.year+"/"+this.month+"/"+this.date:n.replace("YYYY",this.year).replace("MM",this.month).replace("DD",this.date).replace("hh",this.gDate.getHours()).replace("mm",this.gDate.getMinutes()).replace("ss",this.gDate.getSeconds()).replace("tm",this.gDate.getHours()>=12&&this.gDate.getMinutes()>0?"ب.ظ":"ق.ظ").replace("ms",this.gDate.getMilliseconds()).replace("NM",this.months[this.month-1]).replace("DW",this.day).replace("ND",this.dowTitle[this.day])}},n}(),u=function(){function t(){}return t.prototype={toPersianNums:function(n){for(strnum=n.toString(),nums=["۰","۱","۲","۳","۴","۵","۶","۷","۸","۹"],res="",i=0;i<strnum.length;i++)res+=nums[parseInt(strnum[i])];return res},getGDate:function(n){return this.getGCalendarDate(this.getJulianDayFromPersian(n),"gmonth")},getPCalendarDate:function(t){var u=0,f=0,c=0,v,w,h,r;if(t>0){var l=t+.5,y=Math.floor(l),b=l-y,e=Math.floor(t)+.5,i=new n;i.year=475,i.month=1,i.date=1;var a=e-this.getJulianDayFromPersian(i),p=Math.floor(a/1029983),o=a%1029983,s;o==1029982?s=2820:(v=Math.floor(o/366),w=o%366,s=Math.floor((2134*v+2816*w+2815)/1028522)+v+1),u=s+2820*p+474,u<=0&&u--,i.year=u,i.month=1,i.date=1,h=e-this.getJulianDayFromPersian(i)+1,f=h<=186?Math.ceil(h/31):Math.ceil((h-6)/30),i.year=u,i.month=f,i.date=1,c=e-this.getJulianDayFromPersian(i)+1}else alert("Invalid date");return r=new n,r.year=u,r.month=f,r.date=c,r.day=this.getWeekday(this.getJulianDayFromPersian(r)),r.gDate=new Date,r},getGCalendarDate:function(n,t){var e=0,i=0,c=0,a;if(n>0){var l=n+.5,u=Math.floor(l),y=l-u,o;t=="jmonth"||t=="jgmonth"&&u<2299161?o=u:(t=="gmonth"||t=="jgmonth"&&u>=2299161)&&(a=Math.floor((u-1867216.25)/36524.25),o=u+1+a-Math.floor(a/4));var s=o+1524,h=Math.floor((s-122.1)/365.25),v=Math.floor(365.25*h),f=Math.floor((s-v)/30.6001);c=s-v-Math.floor(30.6001*f)+y,f<14?i=f-1:(f==14||f==15)&&(i=f-13),i>2?e=h-4716:(i==1||i==2)&&(e=h-4715)}else alert("Invalid date");return r=new Date,new Date(e,i-1,c,r.getHours(),r.getMinutes(),r.getSeconds(),r.getMilliseconds())},getJulianDay:function(n,t){var t=t===undefined?0:t,r=n.getFullYear(),i=n.getMonth()+1,u=n.getDate(),f=r+0,e=i+0,n=u+0,o,s,h;return e<=2&&(f=f-1,e=e+12),o=0,(u<1||(i==1||i==3||i==5||i==7||i==8||i==10||i==12)&&u>31||(i==4||i==6||i==9||i==11)&&u>30)&&alert("Invalid date"),t==2||t==0&&(r<1582||r==1582&&i<10||r==1582&&i==10&&u<=4)?(o=0,r/4==Math.round(r/4)&&i==2&&u>29&&alert("Invalid date")):t==1||t==0&&(r>1582||r==1582&&i>10||r==1582&&i==10&&u>=15)?(s=Math.floor(f/100),o=2-s+Math.floor(s/4),r/4==Math.round(r/4)&&(r/100==Math.round(r/100)?r/400==Math.round(r/400)&&i==2&&u>29&&alert("Invalid date"):i==2&&u>29&&alert("Invalid date"))):alert("Invalid date"),h=Math.floor(365.25*(f+4716))+Math.floor(30.6001*(e+1))+n+o-1524.5},getJulianDayFromPersian:function(n){y0=n.year,m0=n.month,d0=n.date;var t=y0-(y0>=0?474:473),i=474+t%2820;return d0+(m0<=7?(m0-1)*31:(m0-1)*30+6)+Math.floor((i*682-110)/2816)+(i-1)*365+Math.floor(t/2820)*1029983+(1948320.5-1)},getWeekday:function(n){return wds=[1,2,3,4,5,6,0],wd=Math.floor((n+1.5)%7),wds[wd]},getLastDayOfPersianMonth:function(n){return(y=n.year,m=n.month,m>=1&&m<=6)?31:m>=7&&m<12?30:(m!=12&&alert("Invalid date"),((y-(y>0?474:473))%2820+474+38)*682%2816<682)?30:29}},t}();(function(){Date.prototype._toString=function(n){return(months=["Januray","February","March","April","May","June","Julay","August","September","October","November","December"],dows=["Sun","Mon","Tue","Wed","Tur","Fri","Sat"],n===undefined||n=="default")?this:n.replace("YYYY",this.getFullYear()).replace("MM",this.getMonth()+1).replace("DD",this.getDate()).replace("hh",this.getHours()).replace("mm",this.getMinutes()).replace("ss",this.getSeconds()).replace("ms",this.getMilliseconds()).replace("tm",this.getHours()>=12&&this.getMinutes()>0?"PM":"AM").replace("NM",months[this.getMonth()]).replace("DW",this.getDay()).replace("ND",dows[this.getDay()])},Array.prototype._indexOf=function(n){return $.inArray(n,this)}})()})()
